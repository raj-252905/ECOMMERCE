<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cart – E-Commerce</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <nav class="nav" id="mainNav"></nav>

  <main class="container page">
    <h1 class="page-title">Your Cart</h1>

    <div id="cartContent">
      <div class="cart-list" id="cartList"></div>
      <div class="cart-summary" id="cartSummary"></div>
    </div>

    <div class="cart-empty hide" id="cartEmpty">
      <p>Your cart is empty.</p>
      <a href="home.html" class="btn btn-primary">Continue Shopping</a>
    </div>
  </main>

  <!-- SCRIPT ORDER IMPORTANT -->
  <script src="../js/auth.js"></script>
  <script src="../js/products.js"></script>
  <script src="../js/cart.js"></script>
  <script src="../js/app.js"></script>

  <script>
  (function () {

    if (!requireAuth()) return;
    renderNav('cart');

    const cartList = document.getElementById('cartList');
    const cartSummary = document.getElementById('cartSummary');
    const cartContent = document.getElementById('cartContent');
    const cartEmpty = document.getElementById('cartEmpty');

    function renderCart() {
      const cart = getCart();

      if (!cart.length) {
        cartContent.classList.add('hide');
        cartEmpty.classList.remove('hide');
        return;
      }

      cartContent.classList.remove('hide');
      cartEmpty.classList.add('hide');

      let subtotal = 0;

      const itemsHtml = cart.map(item => {
        const product = getProductById(item.id);
        if (!product) return '';

        const lineTotal = product.price * item.quantity;
        subtotal += lineTotal;

        return `
          <div class="cart-item">
            <img src="${product.image}" alt="${product.name}" />
            <div class="cart-item-info">
              <h3>${product.name}</h3>
              <span class="category">${product.category}</span>
            </div>
            <span class="cart-item-price">$${product.price.toFixed(2)}</span>
            <div class="cart-item-qty">
              <button class="qty-minus" data-id="${product.id}">−</button>
              <span>${item.quantity}</span>
              <button class="qty-plus" data-id="${product.id}">+</button>
            </div>
            <span class="cart-item-price">$${lineTotal.toFixed(2)}</span>
            <button class="btn btn-danger btn-sm btn-remove" data-id="${product.id}">Remove</button>
          </div>
        `;
      }).join('');

      cartList.innerHTML = itemsHtml;

      cartSummary.innerHTML = `
        <h3>Summary</h3>
        <div class="row">
          <span>Subtotal</span>
          <span>$${subtotal.toFixed(2)}</span>
        </div>
        <div class="row total">
          <span>Total</span>
          <span>$${subtotal.toFixed(2)}</span>
        </div>
        <a href="checkout.html" class="btn btn-primary">Proceed to Checkout</a>
      `;

      // Quantity buttons
      cartList.querySelectorAll('.qty-minus').forEach(btn => {
        btn.addEventListener('click', function () {
          const id = parseInt(this.dataset.id, 10);
          const item = cart.find(i => i.id === id);
          if (item) updateQuantity(id, item.quantity - 1);
          renderCart();
          renderNav('cart');
        });
      });

      cartList.querySelectorAll('.qty-plus').forEach(btn => {
        btn.addEventListener('click', function () {
          const id = parseInt(this.dataset.id, 10);
          const item = cart.find(i => i.id === id);
          if (item) updateQuantity(id, item.quantity + 1);
          renderCart();
          renderNav('cart');
        });
      });

      cartList.querySelectorAll('.btn-remove').forEach(btn => {
        btn.addEventListener('click', function () {
          removeFromCart(parseInt(this.dataset.id, 10));
          renderCart();
          renderNav('cart');
        });
      });
    }

    // WAIT FOR PRODUCTS
    productsReady(() => {
      renderCart();
    });

  })();
  </script>
</body>
</html>